(()=>{"use strict";var e=function(e,o,n,t){return new(n||(n=Promise))((function(i,c){function r(e){try{d(t.next(e))}catch(e){c(e)}}function a(e){try{d(t.throw(e))}catch(e){c(e)}}function d(e){var o;e.done?i(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(r,a)}d((t=t.apply(e,o||[])).next())}))};const o=document.querySelector(".video__current-user"),n=document.querySelector(".video__another-user"),t=document.querySelector(".call-controls");if(!t)throw Error("Not found video controls container!");if(!o)throw Error("Not found locale video container!");if(!n)throw Error("Not found remote video container!");const i=t.querySelector(".call-controls__close"),c=t.querySelector(".call-controls__mute"),r=t.querySelector(".call-controls__hide");if(!i||!c||!r)throw Error("Not found some controls buttons in video controls container!");const a={audio:!0,video:{width:{min:300,ideal:500,max:500},height:{min:300,ideal:500,max:500},facingMode:"user"}},d="notify",s=`${d}--active`,l=document.querySelector(`.${d}`);if(!l)throw Error("Not found notify container!");const u=l.querySelector(".notify__text");if(!u)throw Error("Not found notify text container!");const f=()=>l.classList.remove(s);let v;var y=function(e,o,n,t){return new(n||(n=Promise))((function(i,c){function r(e){try{d(t.next(e))}catch(e){c(e)}}function a(e){try{d(t.throw(e))}catch(e){c(e)}}function d(e){var o;e.done?i(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(r,a)}d((t=t.apply(e,o||[])).next())}))};const m=new RTCPeerConnection({iceServers:[{urls:["stun:stun2.1.google.com:19302"]}]});let g;m.addEventListener("icecandidate",(({candidate:e})=>{e&&(console.log("Sending ICE candidate:",e),g.send(JSON.stringify({type:"candidate",data:e})))})),m.addEventListener("connectionstatechange",(()=>{"connected"===m.connectionState&&(console.log("connected"),g.send(JSON.stringify({type:"connected"})))}));y(void 0,void 0,void 0,(function*(){console.log("Initializing media streams");const t=yield e(void 0,void 0,void 0,(function*(){let n;try{n=yield e(void 0,void 0,void 0,(function*(){return yield navigator.mediaDevices.getUserMedia(a)}))}catch(e){throw console.error(e),e}return o.srcObject=n})),d=n.srcObject=new MediaStream;var h;t.getTracks().forEach((e=>{console.log("Local media steams set"),m.addTrack(e,t)})),m.ontrack=({streams:e})=>{console.log("Received remote stream:",e[0]),e[0].getTracks().forEach((e=>{d.addTrack(e)}))},(()=>{console.log("Start communication");const e=location.pathname.split("/").filter(Boolean).at(-1);g=new WebSocket(`ws://${location.host}/call-rooms/${e}/`),g.onmessage=e=>y(void 0,[e],void 0,(function*({data:e}){const o=JSON.parse(e);switch(console.log("Received data:",o),o.type){case"offer":return yield y(void 0,void 0,void 0,(function*(){console.log("Create offer");const e=yield m.createOffer();console.log("Set offer in local description"),yield m.setLocalDescription(e)})),y(void 0,void 0,void 0,(function*(){console.log("Send offer"),g.send(JSON.stringify({type:"offer",data:m.localDescription}))}));case"answer":return yield(i=o.data,y(void 0,void 0,void 0,(function*(){console.log("Set remote offer");const e=new RTCSessionDescription(i);yield m.setRemoteDescription(e)}))),yield y(void 0,void 0,void 0,(function*(){console.log("Create answer");const e=yield m.createAnswer();yield m.setLocalDescription(e)})),console.log("Send answer"),void g.send(JSON.stringify({type:"answer",data:m.localDescription}));case"final":return yield(t=o.data,y(void 0,void 0,void 0,(function*(){console.log("Set remote answer");const e=new RTCSessionDescription(t);yield m.setRemoteDescription(e)})));case"candidate":return yield(n=o.data,y(void 0,void 0,void 0,(function*(){console.log("Adding candidate");try{yield m.addIceCandidate(new RTCIceCandidate(n))}catch(e){console.error("Error adding ICE candidate",e)}})));case"close":return void(location.href=window.homePath);case"time.limit":return void((e,o=1/0)=>{clearTimeout(v),u.textContent=e,l.classList.add(s),o!==1/0&&(v=setTimeout(f,o))})(`You will talk for ${o.data} minutes!`);default:return console.error("Unknown Action type in the call room script!")}var n,t,i}))})(),h=()=>g.send(JSON.stringify({type:"close"})),i.onclick=h,(e=>{c.onclick=()=>{const o=e.getTracks().find((e=>"audio"===e.kind));o&&(o.enabled=!o.enabled)}})(t),(e=>{r.onclick=()=>{const o=e.getTracks().find((e=>"video"===e.kind));o&&(o.enabled=!o.enabled)}})(t)}))})();