{"version":3,"file":"call_rooms.js","mappings":";;;;;;;;;;;;;;;;;;AAAA,iBAAiB,SAAI,IAAI,SAAI;AAC7B,4BAA4B,+DAA+D,iBAAiB;AAC5G;AACA,oCAAoC,MAAM,+BAA+B,YAAY;AACrF,mCAAmC,MAAM,mCAAmC,YAAY;AACxF,gCAAgC;AAChC;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB,gCAAgC;AACjD,kBAAkB,gCAAgC;AAClD;AACA,KAAK;AACL;AACA;AACA;AACA,CAAC;AACM;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACM;AACP;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;UC3EA;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;WCtBA;WACA;WACA;WACA;WACA,yCAAyC,wCAAwC;WACjF;WACA;WACA;;;;;WCPA;;;;;WCAA;WACA;WACA;WACA,uDAAuD,iBAAiB;WACxE;WACA,gDAAgD,aAAa;WAC7D;;;;;;;;;;;;ACNA,iBAAiB,SAAI,IAAI,SAAI;AAC7B,4BAA4B,+DAA+D,iBAAiB;AAC5G;AACA,oCAAoC,MAAM,+BAA+B,YAAY;AACrF,mCAAmC,MAAM,mCAAmC,YAAY;AACxF,gCAAgC;AAChC;AACA,KAAK;AACL;AACA,qBAAqB,SAAI,IAAI,SAAI;AACjC;AACA;AACA,2GAA2G,uFAAuF,cAAc;AAChN,uBAAuB,8BAA8B,gDAAgD,wDAAwD;AAC7J,6CAA6C,sCAAsC,UAAU,mBAAmB,IAAI;AACpH;AACoK;AACpK;AACA,mBAAmB,yCAAyC;AAC5D;AACA;AACA;AACA;AACA;AACA;AACA,mDAAmD,WAAW;AAC9D;AACA;AACA,iDAAiD,wEAAwE;AACzH;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA,+CAA+C,cAAc,cAAc,OAAO;AAClF,wFAAwF,MAAM;AAC9F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iFAAiF,yCAAyC;AAC1H;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,QAAQ;AACxC;AACA;AACA;AACA;AACA,8BAA8B;AAC9B;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA,6CAA6C,wFAAwF;AACrI,CAAC;AACD;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,4DAA4D,6CAA6C;AACzG;AACA;AACA;AACA;AACA;AACA;AACA,4DAA4D,+CAA+C;AAC3G;AACA;AACA;AACA;AACA;AACA,4DAA4D,qDAAqD;AACjH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA,mCAAmC,gFAA4B;AAC/D,8BAA8B,iFAA6B;AAC3D;AACA;AACA;AACA,KAAK;AACL,gCAAgC,SAAS;AACzC;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,IAAI,uEAAmB;AACvB,IAAI,sEAAkB;AACtB,IAAI,sEAAkB;AACtB,CAAC;AACD","sources":["webpack://communications/./apps/calls/ts/components/videos/index.ts","webpack://communications/webpack/bootstrap","webpack://communications/webpack/runtime/define property getters","webpack://communications/webpack/runtime/hasOwnProperty shorthand","webpack://communications/webpack/runtime/make namespace object","webpack://communications/./apps/calls/ts/scripts/call_rooms/main.ts"],"sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nconst localeVideo = document.querySelector('.video__current-user');\nconst remoteVideo = document.querySelector('.video__another-user');\nconst videoControlsContainer = document.querySelector('.call-controls');\nif (!videoControlsContainer) {\n    throw Error('Not found video controls container!');\n}\nif (!localeVideo) {\n    throw Error('Not found locale video container!');\n}\nif (!remoteVideo) {\n    throw Error('Not found remote video container!');\n}\nconst closeButton = videoControlsContainer.querySelector('.call-controls__close');\nconst muteButton = videoControlsContainer.querySelector('.call-controls__mute');\nconst hideButton = videoControlsContainer.querySelector('.call-controls__hide');\nif (!closeButton || !muteButton || !hideButton) {\n    throw Error('Not found some controls buttons in video controls container!');\n}\nconst CONSTRAINTS = {\n    audio: true,\n    video: {\n        width: { min: 640, ideal: 720, max: 720 },\n        height: { min: 480, ideal: 720, max: 720 },\n        facingMode: 'user',\n    },\n};\nconst getLocalMediaStream = () => __awaiter(void 0, void 0, void 0, function* () {\n    return yield navigator.mediaDevices.getUserMedia(CONSTRAINTS);\n});\nexport const createAndSetLocalMediaStream = () => __awaiter(void 0, void 0, void 0, function* () {\n    let localMediaStream;\n    try {\n        localMediaStream = yield getLocalMediaStream();\n    }\n    catch (error) {\n        console.error(error);\n        throw error;\n    }\n    return (localeVideo.srcObject = localMediaStream);\n});\nexport const createAndSetRemoteMediaStream = () => {\n    return (remoteVideo.srcObject = new MediaStream());\n};\nexport const addCloseCallHandler = (callback) => {\n    closeButton.onclick = () => {\n        callback ? callback() : null;\n        location.href = window.homePath;\n    };\n};\nexport const addMuteCallHandler = (localMediaStream) => {\n    muteButton.onclick = () => {\n        const audioTrack = localMediaStream.getTracks().find((track) => track.kind === 'audio');\n        if (!audioTrack) {\n            return;\n        }\n        audioTrack.enabled = !audioTrack.enabled;\n    };\n};\nexport const addHideCallHandler = (localMediaStream) => {\n    hideButton.onclick = () => {\n        const videoTrack = localMediaStream.getTracks().find((track) => track.kind === 'video');\n        if (!videoTrack) {\n            return;\n        }\n        videoTrack.enabled = !videoTrack.enabled;\n    };\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __asyncValues = (this && this.__asyncValues) || function (o) {\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\n    var m = o[Symbol.asyncIterator], i;\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\n};\nimport { createAndSetLocalMediaStream, createAndSetRemoteMediaStream, addCloseCallHandler, addMuteCallHandler, addHideCallHandler, } from '../../components/videos';\nconst RTC_CONFIGURATION = {\n    iceServers: [{ urls: ['stun:stun2.1.google.com:19302'] }],\n};\nconst peerConnection = new RTCPeerConnection(RTC_CONFIGURATION);\nlet callRoomsWebSocket;\nlet offer;\nlet answer;\nlet isClose = false;\npeerConnection.addEventListener('icecandidate', ({ candidate }) => {\n    if (candidate) {\n        console.log('Sending ICE candidate:', candidate);\n        callRoomsWebSocket.send(JSON.stringify({ type: \"candidate.send\" /* ActionType.candidateSend */, data: candidate }));\n    }\n});\npeerConnection.addEventListener('iceconnectionstatechange', () => {\n    if (['connecting', 'connected'].includes(peerConnection.connectionState)) {\n        callRoomsWebSocket.close();\n        isClose = true;\n    }\n});\nconst startCommunication = () => {\n    console.log('Start communication');\n    const roomId = location.pathname.split('/').at(-1);\n    callRoomsWebSocket = new WebSocket(`ws://${location.host}/call-rooms/${roomId}/`);\n    callRoomsWebSocket.onmessage = (_a) => __awaiter(void 0, [_a], void 0, function* ({ data }) {\n        var _b, e_1, _c, _d;\n        const parsedData = JSON.parse(data);\n        console.log('Received data:', parsedData);\n        if (!parsedData.data) {\n            return;\n        }\n        switch (parsedData.type) {\n            case \"who\" /* ActionType.who */: {\n                return yield handleWhoAmI(parsedData.data);\n            }\n            case \"offer.get\" /* ActionType.offerGet */: {\n                yield setOffer(parsedData.data);\n                return yield sendAnswer();\n            }\n            case \"answer.get\" /* ActionType.answerGet */: {\n                return yield setAnswer(parsedData.data);\n            }\n            case \"candidate.get\" /* ActionType.candidateGet */: {\n                try {\n                    for (var _e = true, _f = __asyncValues(parsedData.data), _g; _g = yield _f.next(), _b = _g.done, !_b; _e = true) {\n                        _d = _g.value;\n                        _e = false;\n                        const candidate = _d;\n                        yield addIceCandidate(candidate);\n                    }\n                }\n                catch (e_1_1) { e_1 = { error: e_1_1 }; }\n                finally {\n                    try {\n                        if (!_e && !_b && (_c = _f.return)) yield _c.call(_f);\n                    }\n                    finally { if (e_1) throw e_1.error; }\n                }\n                break;\n            }\n        }\n    });\n};\nconst handleWhoAmI = (whoAmI) => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Handle Who Am I', whoAmI);\n    switch (whoAmI) {\n        case 'starter': {\n            yield sendOffer();\n            return loopSends(getAnswer);\n        }\n        case 'answerer': {\n            return loopSends(getOffer);\n        }\n        default: {\n            return console.error('Incorrect whoAmI value');\n        }\n    }\n});\nconst sendOffer = () => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Send offer');\n    const offer = yield peerConnection.createOffer();\n    yield peerConnection.setLocalDescription(offer);\n    console.log('Set local offer', peerConnection.localDescription);\n    callRoomsWebSocket.send(JSON.stringify({\n        type: \"offer.send\" /* ActionType.offerSend */,\n        data: peerConnection.localDescription,\n    }));\n});\nconst setOffer = (receiverOffer) => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Set offer');\n    offer = new RTCSessionDescription(receiverOffer);\n    yield peerConnection.setRemoteDescription(offer);\n    console.log('Set remote offer');\n    loopSends(getCandidate, 3000);\n});\nconst sendAnswer = () => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Send answer');\n    const answer = yield peerConnection.createAnswer();\n    yield peerConnection.setLocalDescription(answer);\n    callRoomsWebSocket.send(JSON.stringify({ type: \"answer.send\" /* ActionType.answerSend */, data: peerConnection.localDescription }));\n});\nconst setAnswer = (receivedAnswer) => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Setting answer');\n    answer = new RTCSessionDescription(receivedAnswer);\n    yield peerConnection.setRemoteDescription(answer);\n    loopSends(getCandidate, 3000);\n});\nconst loopSends = (callback, time = 500) => {\n    const interval_id = setInterval(() => {\n        if (callback()) {\n            return clearInterval(interval_id);\n        }\n    }, time);\n};\nconst getOffer = () => {\n    console.log('get offer', offer);\n    if (offer) {\n        return true;\n    }\n    return Boolean(callRoomsWebSocket.send(JSON.stringify({ type: \"offer.get\" /* ActionType.offerGet */ })));\n};\nconst getAnswer = () => {\n    console.log('get answer');\n    if (answer) {\n        return true;\n    }\n    return Boolean(callRoomsWebSocket.send(JSON.stringify({ type: \"answer.get\" /* ActionType.answerGet */ })));\n};\nconst getCandidate = () => {\n    if (isClose) {\n        return true;\n    }\n    return Boolean(callRoomsWebSocket.send(JSON.stringify({ type: \"candidate.get\" /* ActionType.candidateGet */ })));\n};\nconst addIceCandidate = (iceCandidate) => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Adding candidate');\n    try {\n        yield peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate));\n    }\n    catch (error) {\n        console.error('Error adding ICE candidate', error);\n    }\n});\nconst init = () => __awaiter(void 0, void 0, void 0, function* () {\n    console.log('Inittializing media streams');\n    const localMediaStream = yield createAndSetLocalMediaStream();\n    const remoteMediaStream = createAndSetRemoteMediaStream();\n    localMediaStream.getTracks().forEach((track) => {\n        console.log('Local media steams set');\n        peerConnection.addTrack(track, localMediaStream);\n    });\n    peerConnection.ontrack = ({ streams }) => {\n        console.log('Received remote stream:', streams[0]);\n        streams[0].getTracks().forEach((track) => {\n            remoteMediaStream.addTrack(track);\n        });\n    };\n    startCommunication();\n    addCloseCallHandler();\n    addMuteCallHandler(localMediaStream);\n    addHideCallHandler(localMediaStream);\n});\ninit();\n"],"names":[],"sourceRoot":""}